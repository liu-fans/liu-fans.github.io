<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Markdown è½¬å›¾ç‰‡å·¥å…· - æ”¯æŒå…¬å¼ã€ç”»å¸ƒè®¾ç½®ä¸æœ¬åœ°æ¨¡æ¿</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/5.2.0/github-markdown.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css">
    <!-- æ·»åŠ  KaTeX æ•°å­¦å…¬å¼æ”¯æŒ -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.3.0/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #f5f7fa 0%, #e4edf9 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        header {
            text-align: center;
            margin: 20px 0;
            padding: 15px;
        }
        
        h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
/*            background: linear-gradient(90deg, #4b6cb7 0%, #182848 100%);*/
/*            -webkit-background-clip: text;*/
            background-clip: text;
/*            color: transparent;*/
            font-weight: 800;
        }
        
        .subtitle {
            color: #666;
            font-size: 1.1rem;
            max-width: 700px;
            margin: 0 auto 20px;
        }
        
        .settings-container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
            padding: 20px;
            margin-bottom: 25px;
        }
        
        .settings-title {
            font-size: 1.3rem;
            margin-bottom: 15px;
            color: #2c3e50;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }
        
        .setting-item {
            display: flex;
            flex-direction: column;
        }
        
        .setting-label {
            margin-bottom: 5px;
            font-weight: 500;
            color: #495057;
        }
        
        .setting-input {
            padding: 8px 12px;
            border: 1px solid #ced4da;
            border-radius: 6px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }
        
        .setting-input:focus {
            border-color: #4b6cb7;
            outline: none;
            box-shadow: 0 0 0 3px rgba(75, 108, 183, 0.2);
        }

        /* === ä¿®æ”¹ï¼šå°†æ ‡é¢˜å’Œæ­£æ–‡å­—ä½“åˆ†å¼€æ§åˆ¶ === */
        .markdown-body {
            /* æ­£æ–‡åŸºç¡€å­—ä½“å¤§å°ç”±ç”¨æˆ·è®¾ç½®æ§åˆ¶ */
            font-size: 16px; /* è¿™ä¸ªå€¼ä¼šè¢«JSåŠ¨æ€ä¿®æ”¹ */
        }

        
        /* === å…³é”®ï¼šè‡ªå®šä¹‰æ ‡é¢˜å­—ä½“å¤§å° === */
        .markdown-body h1 {
            font-size: 1.3em !important;     /* çº¦ 21px */
            margin: 1.1em 0 0.5em 0 !important;

            font-weight: 700 !important;
            color: #1a1a1a !important;
        }
        
        .markdown-body h2 {
            font-size: 1.1em !important;     /* çº¦ 18px */
            margin: 1.0em 0 0.4em 0 !important;

            font-weight: 600 !important;
/*            color: #2c3e50 !important;*/
        }
        
        .markdown-body h3 {
            font-size: 1.0em !important;     /* çº¦ 16px */
            margin: 0.9em 0 0.3em 0 !important;

            font-weight: 600 !important;
/*            color: #34495e !important;*/
        }
        
        .markdown-body h4 {
            font-size: 0.9em !important;     /* çº¦ 21px */
            margin: 0.8em 0 0.2em 0 !important;
            font-weight: 600 !important;
/*            color: #4a6572 !important;*/
        }
        
        .markdown-body h5 {
            font-size: 0.8em !important;     /* çº¦ 18px */
            margin: 0.7em 0 0.2em 0 !important;
            font-weight: 600 !important;
/*            color: #5d6d7e !important;*/
        }
        
        .markdown-body h6 {
            font-size: 0.6em !important;     /* çº¦ 16px */
            margin: 0.5em 0 0.1em 0 !important;
            font-weight: 600 !important;
/*            color: #7f8c8d !important;*/
            text-transform: uppercase !important;
            letter-spacing: 0.5px !important;
        }
        
        /* æ ‡é¢˜é—´è·ä¼˜åŒ– */
        .markdown-body h1 + h2,
        .markdown-body h2 + h3,
        .markdown-body h3 + h4,
        .markdown-body h4 + h5,
        .markdown-body h5 + h6 {
            margin-top: 0.5em !important;
        }

        /* ç¡®ä¿æ ‡é¢˜å†…å®¹å¯è§ */
        .markdown-body h1 *,
        .markdown-body h2 *,
        .markdown-body h3 *,
        .markdown-body h4 *,
        .markdown-body h5 *,
        .markdown-body h6 * {
            color: inherit !important;
            background: transparent !important;
        }



        .main-content {
            display: flex;
            flex-wrap: wrap;
            gap: 25px;
            margin-bottom: 30px;
        }
        
        .editor-container {
            flex: 1;
            min-width: 300px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
            overflow: hidden;
        }
        
        .preview-container {
            flex: 0 0 400px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .preview-header {
            padding: 15px 20px;
            background: #f8f9fa;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .preview-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #2c3e50;
        }
        
        .preview-size {
            font-size: 0.9rem;
            color: #6c757d;
            background: #e9ecef;
            padding: 3px 8px;
            border-radius: 4px;
        }
        
        .preview-frame {
            flex: 1;
            min-height: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 15px;
            background: #f8f9fa;
            overflow: hidden;
        }
        
        .preview-canvas {
            background: #ffffff;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            border-radius: 6px;
            overflow: hidden;
            transform-origin: top left;
            transition: transform 0.3s;
        }
        
        .preview-content {
            padding: 30px;
            min-height: 400px;
            overflow: auto;
        }
        
        .panel-header {
            padding: 15px 20px;
            background: #f8f9fa;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .panel-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #2c3e50;
        }
        
        textarea {
            width: 100%;
            height: 100%;
            min-height: 400px;
            border: none;
            padding: 20px;
            font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace;
            font-size: 16px;
            line-height: 1.5;
            resize: vertical;
            outline: none;
            transition: box-shadow 0.3s;
        }
        
        textarea:focus {
            box-shadow: 0 0 0 3px rgba(75, 108, 183, 0.2);
        }
        
        .action-container {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 12px 28px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        .btn-primary {
            background: linear-gradient(90deg, #4b6cb7 0%, #182848 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(75, 108, 183, 0.4);
        }
        
        .btn-secondary {
            background: #e9ecef;
            color: #495057;
        }
        
        .btn-secondary:hover {
            background: #dee2e6;
            transform: translateY(-2px);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .image-result {
            margin-top: 30px;
            text-align: center;
        }
        
        .result-title {
            font-size: 1.4rem;
            margin-bottom: 15px;
            color: #2c3e50;
        }
        
        #result-image {
            max-width: 100%;
            border-radius: 8px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
            border: 1px solid #eee;
            display: none;
        }
        
        .status {
            margin-top: 10px;
            font-size: 0.95rem;
            color: #6c757d;
            min-height: 24px;
        }
        
        .sample-btn {
            background: none;
            border: 1px solid #4b6cb7;
            color: #4b6cb7;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .sample-btn:hover {
            background: #4b6cb7;
            color: white;
        }
        
        /* åˆ†æ æ ·å¼ */
        .columns {
            display: flex;
            gap: 2px;
            margin: 1px 0;
            flex-wrap: wrap;
        }
        
        .column {
            flex: 1;
            min-width: 250px;
            padding: 1px;
            background: #ffffff;
            border-radius: 1px;
            box-shadow: none;
            border: 1px solid #eee;  // å¯é€‰ï¼šæ·»åŠ è¾¹æ¡†ä¿æŒè¾¹ç•Œæ¸…æ™°
            /* box-shadow: 0 2px 4px rgba(0,0,0,0.1); */
        }
        
        /* æ¨¡æ¿åŒºåŸŸæ ·å¼ */
        .template-section {
            background: white;
            border-radius: 12px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
            padding: 20px;
            margin: 30px 0 20px;
        }
        
        .template-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        
        .template-title {
            font-size: 1.3rem;
            color: #2c3e50;
            margin: 0;
        }
        
        .template-controls {
            display: flex;
            gap: 10px;
        }
        
        .template-file-input {
            display: none;
        }
        
        .template-preview {
            height: 480px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace;
            font-size: 14px;
            line-height: 1.1;
            background: #f8f9fa;
            margin-bottom: 15px;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        
        .template-status {
            font-size: 0.9rem;
            color: #6c757d;
            margin-top: 5px;
        }
        
        .tips-section {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 15px;
            margin: 20px 0;
            border-radius: 0 8px 8px 0;
        }
        
        .tips-title {
            font-weight: 600;
            margin-bottom: 8px;
            color: #0d47a1;
        }
        
        .tips-list {
            padding-left: 20px;
        }
        
        .tips-list li {
            margin-bottom: 5px;
        }
        
        @media (max-width: 900px) {
            .preview-container {
                flex: 1;
                min-width: 300px;
            }
            
            .main-content {
                flex-direction: column;
            }
            
            .template-controls {
                flex-direction: column;
            }
        }
        
        @media (max-width: 768px) {
            h1 {
                font-size: 2rem;
            }
            
            .settings-grid {
                grid-template-columns: 1fr;
            }
            
            .columns {
                flex-direction: column;
            }
            
            .column {
                min-width: 100%;
            }
        }
        
        .canvas-preview {
            width: 100%;
            height: 100%;
            min-height: 300px;
            overflow: auto;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        #canvas-content {
            background: white;
            position: relative;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Markdown è½¬å›¾ç‰‡å·¥å…·</h1>
            <p class="subtitle">æ”¯æŒæ•°å­¦å…¬å¼ã€åˆ†æ å¸ƒå±€ã€è‡ªå®šä¹‰ç”»å¸ƒå°ºå¯¸å’Œæœ¬åœ°æ¨¡æ¿åŠ è½½ï¼Œå®Œå…¨åœ¨æµè§ˆå™¨ä¸­è¿è¡Œ</p>
            <div class="action-container">
                <button class="btn btn-secondary sample-btn" id="load-sample">åŠ è½½ç¤ºä¾‹</button>
                <button class="btn btn-secondary" id="clear-all">æ¸…ç©ºå†…å®¹</button>
                <button class="btn btn-secondary" id="reset-settings">é‡ç½®è®¾ç½®</button>
            </div>
        </header>
        
        <div class="settings-container">
            <div class="settings-title">ğŸ¨ ç”»å¸ƒä¸æ˜¾ç¤ºè®¾ç½®</div>
            <div class="settings-grid">
                <div class="setting-item">
                    <label class="setting-label">ç”»å¸ƒå®½åº¦ (px)</label>
                    <input type="number" id="canvas-width" class="setting-input" value="800" min="300" max="2000">
                </div>
                <div class="setting-item">
                    <label class="setting-label">ç”»å¸ƒé«˜åº¦ (px)</label>
                    <input type="number" id="canvas-height" class="setting-input" value="480" min="200" max="2000">
                </div>
                <div class="setting-item">
                    <label class="setting-label">å­—ä½“å¤§å° (px)</label>
                    <input type="number" id="font-size" class="setting-input" value="16" min="10" max="30">
                </div>
                <div class="setting-item">
                    <label class="setting-label">å†…è¾¹è· (px)</label>
                    <input type="number" id="padding" class="setting-input" value="10" min="2" max="20">
                </div>
                <div class="setting-item">
                    <label class="setting-label">èƒŒæ™¯é¢œè‰²</label>
                    <input type="color" id="bg-color" class="setting-input" value="#ffffff">
                </div>
                <div class="setting-item">
                    <label class="setting-label">è¾¹æ¡†åœ†è§’ (px)</label>
                    <input type="number" id="border-radius" class="setting-input" value="1" min="0" max="5">
                </div>
            </div>
        </div>
        
        <div class="main-content">
            <div class="editor-container">
                <div class="panel-header">
                    <div class="panel-title">Markdown ç¼–è¾‘å™¨</div>
                </div>
                <textarea id="markdown-input" placeholder="åœ¨æ­¤è¾“å…¥ Markdown å†…å®¹..."></textarea>
            </div>
            
            <div class="preview-container">
                <div class="preview-header">
                    <div class="preview-title">ç”»å¸ƒé¢„è§ˆ (800Ã—480)</div>
                    <div class="preview-size" id="current-dimensions">800 Ã— 480 px</div>
                </div>
                <div class="canvas-preview">
                    <div id="canvas-content">
                        <div id="preview-content" class="markdown-body" style="padding: 30px; font-size: 16px;"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="action-container">
            <button class="btn btn-primary" id="convert-btn">
                <span>ç”Ÿæˆå›¾ç‰‡</span>
            </button>
            <button class="btn btn-secondary" id="download-btn" disabled>
                <span>ä¸‹è½½å›¾ç‰‡</span>
            </button>
        </div>
        
        <div class="status" id="status"></div>
        
        <div class="image-result">
            <h2 class="result-title">ç”Ÿæˆçš„å›¾ç‰‡</h2>
            <img id="result-image" alt="Markdown é¢„è§ˆå›¾ç‰‡">
        </div>
        
        <!-- æ¨¡æ¿åŠ è½½åŒºåŸŸ -->
        <div class="template-section">
            <div class="template-header">
                <h2 class="template-title">ğŸ“‚ æœ¬åœ°æ¨¡æ¿åŠ è½½</h2>
                <div class="template-controls">
                    <label class="btn btn-secondary" for="template-file-input">
                        <span>ğŸ“ é€‰æ‹©æ¨¡æ¿æ–‡ä»¶</span>
                    </label>
                    <input type="file" id="template-file-input" class="template-file-input" accept=".md,.txt">
                    <button class="btn btn-secondary" id="load-template-btn" disabled>
                        <span>åŠ è½½æ¨¡æ¿</span>
                    </button>
                </div>
            </div>
            <div class="template-preview" id="template-preview">é€‰æ‹©ä¸€ä¸ª .md æˆ– .txt æ–‡ä»¶æŸ¥çœ‹å†…å®¹...</div>
            <div class="template-status" id="template-status">æ— æ–‡ä»¶é€‰ä¸­</div>
        </div>
        
        <div class="tips-section">
            <div class="tips-title">ğŸ’¡ ä½¿ç”¨æŠ€å·§</div>
            <ul class="tips-list">
                <li>ä½¿ç”¨ <code><div class="columns"></code> åˆ›å»ºåˆ†æ ï¼Œæ å†…å¯è‡ªç”±ä½¿ç”¨æ‰€æœ‰ Markdown è¯­æ³•</li>
                <li>æ•°å­¦å…¬å¼ï¼šè¡Œå†…å…¬å¼ç”¨ <code>$E=mc^2$</code>ï¼Œå—çº§å…¬å¼ç”¨ <code>$$\\int_{-\\infty}^{\\infty} e^{-x^2} dx = \\sqrt{\\pi}$$</code></li>
                <li>é€šè¿‡æœ¬åœ°æ¨¡æ¿æ–‡ä»¶å¿«é€ŸåŠ è½½å¸¸ç”¨æ ¼å¼</li>
                <li>æ‰€æœ‰åŠŸèƒ½å®Œå…¨åœ¨æµè§ˆå™¨ä¸­è¿è¡Œï¼Œæ— éœ€ä¸Šä¼ ä»»ä½•æ•°æ®</li>
            </ul>
        </div>
    </div>

    <script>
        // åˆå§‹åŒ–å˜é‡
        let generatedImage = null;
        let contentScale = 1;
        let selectedTemplateContent = '';
        
        // DOM å…ƒç´ 
        const markdownInput = document.getElementById('markdown-input');
        const previewContent = document.getElementById('preview-content');
        const canvasContent = document.getElementById('canvas-content');
        const convertBtn = document.getElementById('convert-btn');
        const downloadBtn = document.getElementById('download-btn');
        const resultImage = document.getElementById('result-image');
        const statusEl = document.getElementById('status');
        const loadSampleBtn = document.getElementById('load-sample');
        const clearAllBtn = document.getElementById('clear-all');
        const resetSettingsBtn = document.getElementById('reset-settings');
        const canvasWidthInput = document.getElementById('canvas-width');
        const canvasHeightInput = document.getElementById('canvas-height');
        const fontSizeInput = document.getElementById('font-size');
        const paddingInput = document.getElementById('padding');
        const bgColorInput = document.getElementById('bg-color');
        const borderRadiusInput = document.getElementById('border-radius');
        const currentDimensionsEl = document.getElementById('current-dimensions');
        const templateFileInput = document.getElementById('template-file-input');
        const templatePreview = document.getElementById('template-preview');
        const templateStatus = document.getElementById('template-status');
        const loadTemplateBtn = document.getElementById('load-template-btn');
        
        // è®¾ç½®å˜æ›´ç›‘å¬
        canvasWidthInput.addEventListener('change', updateCanvasSettings);
        canvasHeightInput.addEventListener('change', updateCanvasSettings);
        fontSizeInput.addEventListener('change', updateCanvasSettings);
        paddingInput.addEventListener('change', updateCanvasSettings);
        bgColorInput.addEventListener('change', updateCanvasSettings);
        borderRadiusInput.addEventListener('change', updateCanvasSettings);
        
        // æ¨¡æ¿æ–‡ä»¶é€‰æ‹©ç›‘å¬
        templateFileInput.addEventListener('change', handleTemplateFileSelect);
        loadTemplateBtn.addEventListener('click', loadTemplateToEditor);
        
        // é…ç½® marked è§£æå™¨
        marked.setOptions({
            highlight: function(code, lang) {
                const language = hljs.getLanguage(lang) ? lang : 'plaintext';
                return hljs.highlight(code, { language }).value;
            },
            breaks: true,
            gfm: true,
            sanitize: false
        });
        
        // æ›´æ–°ç”»å¸ƒè®¾ç½®
        function updateCanvasSettings() {
            const width = parseInt(canvasWidthInput.value);
            const height = parseInt(canvasHeightInput.value);
            const fontSize = parseInt(fontSizeInput.value);
            const padding = parseInt(paddingInput.value);
            const bgColor = bgColorInput.value;
            const borderRadius = parseInt(borderRadiusInput.value);
            
            // æ›´æ–°é¢„è§ˆå°ºå¯¸æ˜¾ç¤º
            currentDimensionsEl.textContent = `${width} Ã— ${height} px`;
            
            // åº”ç”¨æ ·å¼åˆ°é¢„è§ˆåŒºåŸŸ
            canvasContent.style.width = `${width}px`;
            canvasContent.style.height = `${height}px`;
            canvasContent.style.backgroundColor = bgColor;
            canvasContent.style.borderRadius = `${borderRadius}px`;
            
            previewContent.style.fontSize = `${fontSize}px`;
            previewContent.style.padding = `${padding}px`;
            
            // é‡æ–°æ¸²æŸ“é¢„è§ˆ
            renderPreview();
            
            // è°ƒæ•´å†…å®¹ä»¥é€‚åº”ç”»å¸ƒ
            adjustContentToFit();
        }
        
        // è°ƒæ•´å†…å®¹ä»¥é€‚åº”ç”»å¸ƒ
        function adjustContentToFit() {
            const width = parseInt(canvasWidthInput.value);
            const height = parseInt(canvasHeightInput.value);
            const padding = parseInt(paddingInput.value) * 2;
            
            // è·å–å†…å®¹çš„å®é™…å°ºå¯¸
            const contentWidth = previewContent.scrollWidth;
            const contentHeight = previewContent.scrollHeight;
            
            // è®¡ç®—ç¼©æ”¾æ¯”ä¾‹
            const scaleX = (width - padding - 20) / contentWidth;
            const scaleY = (height - padding - 20) / contentHeight;
            
            // é€‰æ‹©è¾ƒå°çš„æ¯”ä¾‹ï¼Œç¡®ä¿å†…å®¹å®Œæ•´æ˜¾ç¤º
            contentScale = Math.min(1, Math.min(scaleX, scaleY, 1.5));
            
            // åº”ç”¨ç¼©æ”¾
            previewContent.style.transform = `scale(${contentScale})`;
            previewContent.style.transformOrigin = 'top left';
            
            // è°ƒæ•´å®¹å™¨ä»¥é€‚åº”ç¼©æ”¾åçš„å†…å®¹
            canvasContent.style.display = 'flex';
            canvasContent.style.justifyContent = 'center';
            canvasContent.style.alignItems = 'flex-start';
            canvasContent.style.paddingTop = `${(height - contentHeight * contentScale) / 2}px`;
        }
        
        // å®æ—¶é¢„è§ˆ
        function renderPreview() {
            const markdownText = markdownInput.value;
            const htmlContent = marked.parse(markdownText);
            previewContent.innerHTML = htmlContent;

            // // å¤„ç†å›¾ç‰‡è·¨åŸŸé—®é¢˜
            // const images = previewContent.querySelectorAll('img');
            // images.forEach(img => {
            //     // è®¾ç½®crossOriginå±æ€§ä»¥é¿å…è·¨åŸŸé—®é¢˜
            //     if (!img.src.startsWith('data:') && !img.src.startsWith('blob:')) {
            //         img.crossOrigin = 'anonymous';
            //     }
            // });

            
            // å…ˆæ‰§è¡Œä»£ç é«˜äº®
            hljs.highlightAll();
            
            // ç„¶åæ¸²æŸ“æ•°å­¦å…¬å¼
            setTimeout(() => {
                renderMathInElement(previewContent, {
                    delimiters: [
                        {left: '$$', right: '$$', display: true},
                        {left: '$', right: '$', display: false},
                        {left: '\\(', right: '\\)', display: false},
                        {left: '\\[', right: '\\]', display: true}
                    ],
                    ignoredTags: ['script', 'noscript', 'style', 'textarea', 'pre']
                });
                
                // è°ƒæ•´å†…å®¹ä»¥é€‚åº”ç”»å¸ƒ
                adjustContentToFit();
            }, 100);
        }
        
        // ç”Ÿæˆå›¾ç‰‡
        async function convertToImage() {
            setStatus('æ­£åœ¨ç”Ÿæˆå›¾ç‰‡ï¼Œè¯·ç¨å€™...');
            convertBtn.disabled = true;
            convertBtn.innerHTML = '<span>ç”Ÿæˆä¸­...</span>';
            
            try {
                // åº”ç”¨å½“å‰è®¾ç½®
                const width = parseInt(canvasWidthInput.value);
                const height = parseInt(canvasHeightInput.value);
                const fontSize = parseInt(fontSizeInput.value);
                const padding = parseInt(paddingInput.value);
                const bgColor = bgColorInput.value;
                const borderRadius = parseInt(borderRadiusInput.value);
                
                // åˆ›å»ºä¸€ä¸ªä¸´æ—¶å®¹å™¨ç”¨äºæˆªå›¾
                const tempContainer = document.createElement('div');
                tempContainer.style.width = `${width}px`;
                tempContainer.style.height = `${height}px`;
                tempContainer.style.padding = '0';
                tempContainer.style.margin = '0';
                tempContainer.style.backgroundColor = bgColor;
                tempContainer.style.borderRadius = `${borderRadius}px`;
                tempContainer.style.overflow = 'hidden';
                tempContainer.style.position = 'fixed';
                tempContainer.style.left = '-9999px';
                tempContainer.style.top = '-9999px';
                tempContainer.style.fontFamily = 'system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif';
                
                // åˆ›å»ºå†…å®¹å®¹å™¨
                const contentContainer = document.createElement('div');
                contentContainer.className = 'markdown-body';
                contentContainer.style.padding = `${padding}px`;
                contentContainer.style.fontSize = `${fontSize}px`;
                contentContainer.style.width = '100%';
                contentContainer.style.height = '100%';
                contentContainer.style.boxSizing = 'border-box';
                contentContainer.style.overflow = 'hidden';
                contentContainer.style.lineHeight = '1.6';
                
                // å¤åˆ¶é¢„è§ˆå†…å®¹
                contentContainer.innerHTML = previewContent.innerHTML;
                
                // // å¤„ç†ä¸´æ—¶å®¹å™¨ä¸­çš„å›¾ç‰‡
                // const tempImages = contentContainer.querySelectorAll('img');
                // for (let img of tempImages) {
                //     // æ£€æŸ¥æ˜¯å¦ä¸ºè·¨åŸŸå›¾ç‰‡
                //     if (!img.src.startsWith('data:') && 
                //         !img.src.startsWith('blob:') && 
                //         !img.src.startsWith(window.location.origin)) {
                        
                //         // å¦‚æœæ˜¯è·¨åŸŸå›¾ç‰‡ï¼Œå°è¯•è®¾ç½®crossOrigin
                //         img.crossOrigin = 'anonymous';
                        
                //         // ç­‰å¾…å›¾ç‰‡åŠ è½½å®Œæˆ
                //         try {
                //             await new Promise((resolve, reject) => {
                //                 const timeout = setTimeout(() => reject(new Error('å›¾ç‰‡åŠ è½½è¶…æ—¶')), 5000);
                //                 img.onload = () => {
                //                     clearTimeout(timeout);
                //                     resolve();
                //                 };
                //                 img.onerror = () => {
                //                     clearTimeout(timeout);
                //                     // å¦‚æœå›¾ç‰‡åŠ è½½å¤±è´¥ï¼Œç§»é™¤è¯¥å›¾ç‰‡å…ƒç´ 
                //                     img.remove();
                //                     resolve();
                //                 };
                //             });
                //         } catch (e) {
                //             console.warn('å›¾ç‰‡åŠ è½½å¤±è´¥:', img.src, e);
                //             img.remove(); // ç§»é™¤åŠ è½½å¤±è´¥çš„å›¾ç‰‡
                //         }
                //     }
                // }


                // å°†å†…å®¹å®¹å™¨æ·»åŠ åˆ°ä¸´æ—¶å®¹å™¨
                tempContainer.appendChild(contentContainer);
                
                // å°†ä¸´æ—¶å®¹å™¨æ·»åŠ åˆ° body
                document.body.appendChild(tempContainer);
                
                // ç­‰å¾…å†…å®¹æ¸²æŸ“
                await new Promise(resolve => setTimeout(resolve, 100));
                
                // ä½¿ç”¨ html2canvas ç”Ÿæˆå›¾ç‰‡
                const canvas = await html2canvas(tempContainer, {
                    scale: 2,
                    useCORS: true,
                    logging: false,
                    backgroundColor: null,
                    width: width,
                    height: height
                    // allowTaint: false, // å…³é”®ï¼šä¸å…è®¸æ±¡æŸ“
                    // onclone: function(clonedDoc) {
                    //     // åœ¨å…‹éš†æ–‡æ¡£ä¸­å¤„ç†å›¾ç‰‡
                    //     const clonedImages = clonedDoc.querySelectorAll('img');
                    //     clonedImages.forEach(img => {
                    //         if (!img.src.startsWith('data:') && 
                    //             !img.src.startsWith('blob:')) {
                    //             img.crossOrigin = 'anonymous';
                    //         }
                    //     });
                    // }

                });
                
                // ç§»é™¤ä¸´æ—¶å®¹å™¨
                document.body.removeChild(tempContainer);
                
                // è°ƒæ•´ç”»å¸ƒåˆ°å®é™…å°ºå¯¸
                const finalCanvas = document.createElement('canvas');
                finalCanvas.width = width;
                finalCanvas.height = height;
                const ctx = finalCanvas.getContext('2d');
                ctx.drawImage(canvas, 0, 0, width, height);
                
                // è½¬æ¢ä¸ºå›¾ç‰‡
                generatedImage = finalCanvas.toDataURL('image/png');
                resultImage.src = generatedImage;
                resultImage.style.display = 'inline-block';
                resultImage.style.width = `${width}px`;
                resultImage.style.height = `${height}px`;
                resultImage.style.maxWidth = '100%';
                
                // å¯ç”¨ä¸‹è½½æŒ‰é’®
                downloadBtn.disabled = false;
                
                setStatus(`å›¾ç‰‡ç”ŸæˆæˆåŠŸï¼å°ºå¯¸: ${width}Ã—${height}px`, 'success');
            } catch (error) {
                console.error('ç”Ÿæˆå›¾ç‰‡æ—¶å‡ºé”™:', error);
                setStatus(`é”™è¯¯: ${error.message || 'ç”Ÿæˆå›¾ç‰‡å¤±è´¥'}`, 'error');
            } finally {
                convertBtn.disabled = false;
                convertBtn.innerHTML = '<span>ç”Ÿæˆå›¾ç‰‡</span>';
            }
        }
        
        // ä¸‹è½½å›¾ç‰‡
        function downloadImage() {
            if (!generatedImage) return;
            
            const link = document.createElement('a');
            link.download = `markdown-preview-${Date.now()}.png`;
            link.href = generatedImage;
            link.click();
            
            setStatus('å›¾ç‰‡å·²ä¸‹è½½åˆ°æ‚¨çš„è®¾å¤‡', 'success');
        }
        
        // è®¾ç½®çŠ¶æ€ä¿¡æ¯
        function setStatus(message, type = 'info') {
            statusEl.textContent = message;
            statusEl.style.color = type === 'success' ? '#28a745' : 
                                   type === 'error' ? '#dc3545' : '#6c757d';
            // 5ç§’åæ¸…é™¤çŠ¶æ€
            setTimeout(() => {
                if (statusEl.textContent === message) {
                    statusEl.textContent = '';
                }
            }, 5000);
        }
        
        // å¤„ç†æ¨¡æ¿æ–‡ä»¶é€‰æ‹©
        function handleTemplateFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // æ£€æŸ¥æ–‡ä»¶ç±»å‹
            if (!file.name.endsWith('.md') && !file.name.endsWith('.txt')) {
                templateStatus.textContent = 'âš ï¸ è¯·åªé€‰æ‹© .md æˆ– .txt æ–‡ä»¶';
                templateStatus.style.color = '#dc3545';
                loadTemplateBtn.disabled = true;
                return;
            }
            
            // è¯»å–æ–‡ä»¶å†…å®¹
            const reader = new FileReader();
            reader.onload = function(e) {
                selectedTemplateContent = e.target.result;
                templatePreview.textContent = selectedTemplateContent;
                templateStatus.textContent = `å·²é€‰æ‹©: ${file.name} (${(file.size / 1024).toFixed(1)} KB)`;
                templateStatus.style.color = '#28a745';
                loadTemplateBtn.disabled = false;
            };
            reader.onerror = function() {
                templateStatus.textContent = 'âŒ è¯»å–æ–‡ä»¶å¤±è´¥';
                templateStatus.style.color = '#dc3545';
                loadTemplateBtn.disabled = true;
            };
            reader.readAsText(file);
        }
        
        // åŠ è½½æ¨¡æ¿åˆ°ç¼–è¾‘å™¨
        function loadTemplateToEditor() {
            if (!selectedTemplateContent) return;
            
            // ç¡®è®¤æ˜¯å¦è¦†ç›–å½“å‰å†…å®¹
            if (markdownInput.value.trim() !== '') {
                if (!confirm('å½“å‰ç¼–è¾‘å™¨å†…å®¹å°†è¢«è¦†ç›–ï¼Œæ˜¯å¦ç»§ç»­ï¼Ÿ')) {
                    return;
                }
            }
            
            markdownInput.value = selectedTemplateContent;
            renderPreview();
            templateStatus.textContent = 'âœ… æ¨¡æ¿å·²æˆåŠŸåŠ è½½åˆ°ç¼–è¾‘å™¨';
            templateStatus.style.color = '#28a745';
        }
        
        // åŠ è½½ç¤ºä¾‹å†…å®¹
        function loadSample() {
            markdownInput.value = `# æ•°å­¦å…¬å¼ä¸åˆ†æ ç¤ºä¾‹

## æ•°å­¦å…¬å¼æ¼”ç¤º

è¡Œå†…å…¬å¼ï¼š$E = mc^2$

å—çº§å…¬å¼ï¼š
$$\\int_{-\\infty}^{\\infty} e^{-x^2} dx = \\sqrt{\\pi}$$

å¤æ‚å…¬å¼ï¼š
$$\\sum_{i=1}^{n} i = \\frac{n(n+1)}{2}$$

çŸ©é˜µï¼š
$$
\\begin{pmatrix}
a & b \\\\
c & d
\\end{pmatrix}
$$

## åˆ†æ å¸ƒå±€

<div class="columns">
  <div class="column">

### å·¦æ ï¼šå…¬å¼è¯´æ˜

- **ç§¯åˆ†å…¬å¼**:
  $$\\int_a^b f(x)dx = F(b) - F(a)$$

- **æ±‚å’Œå…¬å¼**:
  $$\\sum_{k=1}^n k^2 = \\frac{n(n+1)(2n+1)}{6}$$

- **æ¬§æ‹‰å…¬å¼**:
  $$e^{i\\pi} + 1 = 0$$

  </div>
  <div class="column">

### å³æ ï¼šåº”ç”¨åœºæ™¯

\`\`\`python
import numpy as np
from scipy import integrate

# æ•°å€¼ç§¯åˆ†ç¤ºä¾‹
def gaussian(x):
    return np.exp(-x**2)

result, error = integrate.quad(gaussian, -np.inf, np.inf)
print(f"ç§¯åˆ†ç»“æœ: {result}")
\`\`\`

- ç‰©ç†å­¦ä¸­çš„åº”ç”¨
- å·¥ç¨‹è®¡ç®—
- ç»Ÿè®¡åˆ†æ

  </div>
</div>`;
            renderPreview();
            setStatus('å·²åŠ è½½ç¤ºä¾‹å†…å®¹', 'success');
        }
        
        // æ¸…ç©ºæ‰€æœ‰å†…å®¹
        function clearAll() {
            markdownInput.value = '';
            previewContent.innerHTML = '';
            resultImage.src = '';
            resultImage.style.display = 'none';
            downloadBtn.disabled = true;
            generatedImage = null;
            setStatus('å†…å®¹å·²æ¸…ç©º', 'success');
        }
        
        // é‡ç½®è®¾ç½®
        function resetSettings() {
            canvasWidthInput.value = '800';
            canvasHeightInput.value = '480';
            fontSizeInput.value = '16';
            paddingInput.value = '5';
            bgColorInput.value = '#ffffff';
            borderRadiusInput.value = '1';
            updateCanvasSettings();
            setStatus('è®¾ç½®å·²é‡ç½®ä¸ºé»˜è®¤å€¼', 'success');
        }
        
        // äº‹ä»¶ç›‘å¬
        markdownInput.addEventListener('input', renderPreview);
        convertBtn.addEventListener('click', convertToImage);
        downloadBtn.addEventListener('click', downloadImage);
        loadSampleBtn.addEventListener('click', loadSample);
        clearAllBtn.addEventListener('click', clearAll);
        resetSettingsBtn.addEventListener('click', resetSettings);
        
        // è‡ªåŠ¨è°ƒæ•´çª—å£å¤§å°å˜åŒ–
        window.addEventListener('resize', () => {
            adjustContentToFit();
        });
        
        // ç›‘å¬ç”»å¸ƒå†…å®¹å˜åŒ–ï¼Œè‡ªåŠ¨è°ƒæ•´
        const resizeObserver = new ResizeObserver(() => {
            adjustContentToFit();
        });
        resizeObserver.observe(previewContent);
        
        // åˆå§‹åŒ–
        updateCanvasSettings();
        
        // è®¾ç½®é»˜è®¤å†…å®¹
        markdownInput.value = `# å¼€å§‹ä½¿ç”¨

## æœ¬åœ°æ¨¡æ¿åŠŸèƒ½

1. ç‚¹å‡» "ğŸ“ é€‰æ‹©æ¨¡æ¿æ–‡ä»¶" é€‰æ‹© .md æˆ– .txt æ–‡ä»¶
2. æŸ¥çœ‹æ–‡ä»¶å†…å®¹é¢„è§ˆ
3. ç‚¹å‡» "åŠ è½½æ¨¡æ¿" å°†å†…å®¹è½½å…¥ç¼–è¾‘å™¨
4. ç¼–è¾‘åç”Ÿæˆå›¾ç‰‡

## æ”¯æŒçš„è¯­æ³•

- æ‰€æœ‰æ ‡å‡† Markdown
- æ•°å­¦å…¬å¼ï¼š$E=mc^2$ å’Œ $$\\int_{-\\infty}^{\\infty} e^{-x^2} dx = \\sqrt{\\pi}$$
- åˆ†æ å¸ƒå±€ï¼š<div class="columns">...</div>
- HTML æ ‡ç­¾å’Œæ ·å¼

> æœ¬å·¥å…·å®Œå…¨åœ¨æµè§ˆå™¨ä¸­è¿è¡Œï¼Œæ— éœ€ä¸Šä¼ ä»»ä½•æ•°æ®ï¼Œä¿æŠ¤æ‚¨çš„éšç§ï¼`;
        renderPreview();
    </script>
</body>
</html>